{
  "version": 3,
  "sources": ["../src/index.ts", "../src/effect.ts", "../../shared/src/index.ts", "../src/baseHandler.ts", "../src/reactive.ts", "../src/computed.ts"],
  "sourcesContent": ["import { reactive } from './reactive';\r\nexport {effect} from './effect'\r\nexport {reactive} from './reactive'\r\nexport {computed} from './computed'", "\r\nexport\u3000let activeEffect = undefined\r\nfunction cleanEffect(effect){\r\n    //\u6E05\u7406effect \u4E2D\u5B58\u5165\u5C5E\u6027\u4E2D set \u4E2D\u7684effect\r\n\r\n    // \u6BCF\u6B21\u6267\u884C\u524D\u90FD\u9700\u8981\u5C06effect \u53EA\u5BF9\u5E94\u5C5E\u6027\u7684set\u96C6\u5408\u90FD\u6E05\u7406\u6389\r\n    let deps = effect.deps\r\n    for(let i = 0; i <deps.length ; i++){\r\n        deps[i].delete(effect)\r\n    }\r\n    effect.deps.length = 0\r\n}\r\nexport class ReactiveEffect{\r\n    public active = true\r\n    public parent = null\r\n    public deps = []\r\n    constructor(public fn,public scheduler?){ // \u4F20\u9012\u7684fn \u653E\u5230this \u4E0A\r\n        \r\n    }\r\n    run(){\r\n        //\u4F9D\u8D56\u6536\u96C6 \u8BA9\u5C5E\u6027\u8DDFeffect\u4EA7\u751F\u5173\u8054\r\n        if(!this.active){\r\n            return this.fn()\r\n        }else{\r\n            try{\r\n                this.parent = activeEffect\r\n                activeEffect = this\r\n                cleanEffect(this)\r\n                return this.fn()\r\n            }finally{\r\n                //\u53D6\u6D88activeEffect \u7684\u6536\u96C6\r\n                activeEffect = this.parent\r\n                this.parent = null\r\n            }\r\n\r\n        }\r\n        \r\n    }\r\n    stop(){\r\n        if(this.active) this.active = false\r\n        cleanEffect(this)\r\n    }\r\n}\r\n\r\n\r\n//\u54EA\u4E2A\u5BF9\u8C61\u4E2D \u7684\u54EA\u4E2A\u5C5E\u6027\u5BF9\u5E94\u54EA\u4E2Aeffect \u4E00\u4E2A\u5C5E\u6027\u53EF\u4EE5\u5BF9\u5E94\u591A\u4E2Aeffect\r\n// \u5916\u5C42\u7528\u4E00\u4E2Amap{object:{name:[effect,effect]}\r\n\r\nconst targetkMap = new WeakMap()\r\n\r\nexport function trigger(target,key,value){\r\n    let depsMap = targetkMap.get(target)\r\n    if(!depsMap){\r\n        return\r\n    }\r\n    let effects = depsMap.get(key)\r\n    traggeEffect(effects)\r\n}\r\n\r\nexport function traggeEffect(effects){\r\n    if(effects){\r\n        effects = new Set(effects) // \u590D\u5236\u4E00\u4E2A\u65B0\u7684 \u907F\u514D\u5FAA\u73AF\u7684\u65F6\u540E\u6B7B\u5FAA\u73AF\r\n        effects.forEach(effect => {\r\n            if(effect !== activeEffect){ // \u5982\u679C\u662F\u901A\u4E00\u4E2A\u7684\u8BDD \u5C31\u4F1A\u6B7B\u5FAA\u73AF\r\n                if(effect.scheduler){\r\n                    effect.scheduler()\r\n                }else{\r\n                    effect.run() //\u91CD\u65B0\u6267\u884Ceffect\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\nexport function  track(target,key){\r\n    if(activeEffect){\r\n        let depsMap = targetkMap.get(target)\r\n        if(!depsMap){\r\n            targetkMap.set(target,(depsMap = new Map()))\r\n        }\r\n        let deps = depsMap.get(key)\r\n        if(!deps){\r\n            depsMap.set(key,(deps = new Set()))\r\n        }\r\n        trackEffect(deps)\r\n       \r\n        // console.log(targetkMap)\r\n      \r\n    }\r\n   //\u8BA9\u5C5E\u6027\u8BB0\u5F55\u6240 \u7528\u5230\u7684effect \u54EA\u4E2Aeffect \u5BF9\u5E94\u4E86\u54EA\u4E2A\u5C5E\u6027\r\n}\r\nexport function trackEffect(deps){\r\n    let shouleTrack = !deps.has(activeEffect)\r\n    if(shouleTrack){\r\n        deps.add(activeEffect)\r\n        activeEffect.deps.push(deps)\r\n    }\r\n}\r\n\r\nexport function effect(fn,options = {} as any){\r\n\r\n    \r\n\r\n    //\u5C06\u7528\u6237\u4F20\u9012\u7684\u51FD\u6570 \u53D8\u6210\u54CD\u5E94\u5F0F\u7684effect\r\n\r\n    const _effect = new ReactiveEffect(fn,options.scheduler)\r\n    // \u66F4\u6539 runner \u4E2D\u7684this\r\n    _effect.run()\r\n    \r\n    const runner = _effect.run.bind(_effect)\r\n\r\n    runner.effect = _effect //\u66B4\u9732effect\u5B9E\u4F8B\r\n    return runner\r\n}", "export const isObject = (value) =>{\r\n    return typeof value === 'object' && value !== null\r\n}\r\nexport const isFunction = (value)=>{\r\n    return typeof value === 'function'\r\n}", "import { triggerRef } from 'vue';\r\nimport { track, trigger } from './effect';\r\nimport { isObject } from '../../shared/src/index';\r\nimport { reactive } from './reactive';\r\nexport const enum ReactiveFlags {\r\n    IS_REACTIVE = '_v_isReactive'\r\n}\r\nexport const baseHandler =  {\r\n    get(target,key,receiver){\r\n        if(key === ReactiveFlags.IS_REACTIVE){\r\n            return true\r\n        }\r\n        // \u6536\u96C6\u4F9D\u8D56\r\n        track(target,key)\r\n\r\n        // lazy proxy \u5982\u679C\u5C5E\u6027\u662F\u5BF9\u8C61 \u5C31\u7EE7\u7EED\u4EE3\u7406\r\n        let res = Reflect.get(target,key,receiver)\r\n        if(isObject(res)){\r\n            return reactive(res)\r\n        }\r\n        // console.log('\u8FD9\u91CC\u53EF\u4EE5\u8BB0\u5F55\u54EA\u4E2A\u5C5E\u6027\u4F7F\u7528\u4E86\u54EA\u4E2Aeffect')\r\n        return res\r\n    },\r\n    set(target,key,value,receiver){\r\n        \r\n        //\u6570\u636E\u53D8\u5316\u540E\u8981\u6839\u636E\u5C5E\u6027\u503C\u627E\u5230\u5BF9\u5E94\u7684effect \u5217\u8868\u8BA9\u5176\u4F9D\u6B21\u6267\u884C\r\n        \r\n        let oldValue = target[key]\r\n        let result = true\r\n        if(oldValue !== value){\r\n            result = Reflect.set(target,key,value,receiver)\r\n            trigger(target,key,value)\r\n        }\r\n        return  result\r\n    }\r\n}", "import { isObject } from \"@vue/shared\"\r\nimport {baseHandler,ReactiveFlags} from \"./baseHandler\";\r\n\r\n\r\nconst reactiveMap = new WeakMap() //key \u5FC5\u987B\u662F\u5BF9\u8C61\r\n// v8 \u5783\u573E\u56DE\u6536\u673A\u5236 \uFF0C\u6807\u8BB0\u5220\u9664 \u5F15\u7528\u8BA1\u6570 \r\n\r\n\r\n\r\nexport function reactive(target){\r\n    if(!isObject(target)){\r\n        return target\r\n    }\r\n    if(target[ReactiveFlags.IS_REACTIVE]){\r\n        return target\r\n    }\r\n    const existing = reactiveMap.get(target)\r\n    if(existing){\r\n        return existing\r\n    }\r\n    const proxy = new Proxy(target,baseHandler)\r\n    reactiveMap.set(target,proxy)\r\n    //\u4E00\u4E2A\u5BF9\u8C61 \u88AB\u4EE3\u7406\u4E86 \u5C31\u4E0D\u8981\u4EE3\u7406\u4E86\r\n\r\n    return proxy\r\n}\r\n// \u4F7F\u7528proxy \u8981\u642D\u914DReflect \u6765\u4F7F\u7528\r\n\r\n// let person = {\r\n//     name:'ab',\r\n//     get aliasName(){ // \u5C5E\u6027\u8BBF\u95EE\u5668\r\n//         return this.name + 'jb'\r\n//     }\r\n// }\r\n// const proxy = new Proxy(person,{\r\n//     get(target,key,receiver){\r\n//         console.log('\u8FD9\u91CC\u53EF\u4EE5\u8BB0\u5F55\u54EA\u4E2A\u5C5E\u6027\u4F7F\u7528\u4E86\u54EA\u4E2Aeffect')\r\n//         return Reflect.get(target,key,receiver)\r\n//     },\r\n//     set(target,key,value,receiver){\r\n//         console.log('\u8FD9\u91CC\u53EF\u4EE5\u901A\u77E5effect\u91CD\u65B0\u6267\u884C')\r\n//         return Reflect.set(target,key,value,receiver)\r\n//     }\r\n// })\r\n// proxy.aliasName\r\n//  \u8FD9\u91CC\u53D6aliasName \u503C\u7684\u65F6\u5019 \u6267\u884C\u4E86get \u65B9\u6CD5\r\n// \u4F46\u662F aliasName \u662F\u57FA\u4E8Ename \u53D6\u503C \u539F\u5219\u4E0A\u5E94\u8BE5\u518D\u8BBF\u95EE\u4E00\u6B21name\r\n// \u7136\u800C this.name \u5E76\u6CA1\u6709\u5BF9proxy \u7684get \u4E5F\u610F\u5473\u7740\u540E\u9762\u4FEE\u6539name \r\n// \u4E0D\u4F1A\u5BFC\u81F4\u9875\u9762\u66F4\u65B0\r\n\r\n// \u7528\u4E86reflect\u4E4B\u540E \u5C31\u4F1A\u518D\u8C03\u7528\u4E00\u6B21get \u800C\u4E14 \u4F1A\u4ECEtarget\u4E0A\u9762\u91CD\u65B0\u53D6\u503C\r\n// \u8FD9\u5C31\u662F\u4E3A\u5565proxy\u8981\u8DDFreflect\u914D\u5408\u4F7F\u7528", "import { isFunction } from '@vue/shared';\r\nimport { ReactiveEffect, effect, activeEffect, trackEffect, traggeEffect } from './effect';\r\nexport function computed(getterOrOptions){\r\n    let isGetter = isFunction(getterOrOptions)\r\n    let getter,setter\r\n    let fn = ()=>console.warn('computed is readonly')\r\n    if(isGetter){\r\n        getter = getterOrOptions\r\n        setter = fn\r\n    }else{\r\n        getter = getterOrOptions.get\r\n        setter = getterOrOptions.set || fn \r\n    }\r\n    return new ComputedRefImpl(getter,setter)\r\n}\r\nclass ComputedRefImpl{\r\n    private _value\r\n    private _dirty = true\r\n    public effect\r\n    public deps\r\n    constructor(getter,public setter){\r\n        // \u62FF\u5230effect\u5B9E\u4F8B \u8BA9\u51FD\u6570\u6267\u884C\r\n       this.effect = new ReactiveEffect(getter,()=>{\r\n        if(!this._dirty){\r\n            this._dirty = true\r\n            traggeEffect(this.deps)\r\n        }\r\n       })\r\n    }\r\n    get value(){ // \u53EA\u6709\u5F53\u3002value \u7684\u65F6\u5019 dirty\u4E3Atrue\u6267\u884C\r\n        \r\n        if(activeEffect){\r\n            //\u8BA9\u8BA1\u7B97\u5C5E\u6027\u505A\u4F9D\u8D56\u6536\u96C6\r\n            // debugger\r\n            trackEffect(this.deps ||(this.deps = new Set()) )\r\n        }\r\n        if(this._dirty){\r\n            this._dirty = false\r\n            this._value = this.effect.run()\r\n        }\r\n        return this._value\r\n    }\r\n    set value(newValue){\r\n        this.setter(newValue)\r\n    }\r\n}"],
  "mappings": "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",
  "names": ["effect"]
}
